<!DOCTYPE html>
<html lang="en">
  {% load static %}
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'css/logins/findId.css' %}" />
    <script
      src="https://kit.fontawesome.com/b453b8b1fc.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>FINDID</title>
  </head>


<body>

<div>
    <div class="container">
        <div class="title">
            <div class="btitle">아이디 찾기</div>
            <div class="stitle">이름과 이메일을 입력해주세요</div>
        </div>

    {% csrf_token %}
        <div class="findid_input">
            <div class="name_input">
                <label name="label_name" for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                {{ form.name }}
            </div>
            <div class="email_input">
                <label name="label_email" for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                    {{ form.email }}
                <div class="mail_ment">
                    등록하신 메일로 인증번호가 발송됩니다.
                </div>
            </div>
        </div>

        <div class="find_id">
            <button id="find_id" 
            name="find_id">아이디찾기</button>
        </div>
        <div id="loading"></div>
        <div id="result_Id"></div>
    </div>
</div>

<script>
    const button = document.querySelector('#find_id');
    button.addEventListener('click', (event) => {
        var name = document.querySelector('#id_form_name').value;
        var email = document.querySelector('#id_form_email').value;
        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = 'X-CSRFToken';

        axios.post(
            '/logins/find/id/find',
            {
            'name': name,
            'email': email,
            },)

        .then((response) => {
            alert('회원님의 이메일로 인증코드를 발송하였습니다.');
            const element = document.querySelector('#result_Id');
            
            element.innerHTML = '<div class="row justify-content-md-center"><form class="form-inline"><div class="md-form md-outline"><label class="certificate_num" for="input_auth_num">인증번호 입력</label><input type="text" id="input_auth_num" class="form-control mx-sm-2" autofocus/></div></form>'+
            '<button type="submit" name="auth_confirm" id="id_auth_confirm" class="btn-certi"><i class="fas fa-check"></i>&nbsp;&nbsp;인증확인</button></div>'
            
            function countdown( elementName, minutes, seconds ) {
                        var elementName, endTime, hours, mins, msLeft, time;
                        function twoDigits( n ) {
                            return (n <= 9 ? "0" + n : n);
                        }
                        function updateTimer() {
                            msLeft = endTime - (+new Date);
                            if ( msLeft < 1000 ) {
                                alert("인증시간이 초과되었습니다.");
                                elementName.remove();
                                cert_ok = false;
                                certificationNum = false;
                                location.href = "{% url 'logins:findPw' %}"
                            } else {
                                time = new Date( msLeft );
                                hours = time.getUTCHours();
                                mins = time.getUTCMinutes();
                            //   $("" + elementName).html((hours ? hours + ':' + twoDigits( mins ) : twoDigits(mins))
                            //   + ':' + twoDigits( time.getUTCSeconds()));
                                setTimeout( updateTimer, time.getUTCMilliseconds() + 500 );
                            }
                        }
                      endTime = (+new Date) + 1000 * (60*minutes + seconds) + 500;
                        updateTimer();
                    }
            countdown("#timeset", 5, 0);

            var email = response.data.result
            console.log(response.data.username)
            const confirmButton = document.querySelector('#id_auth_confirm');
            confirmButton.addEventListener('click', (event) => {
                var inputAuthNum = document.querySelector('#input_auth_num').value;
                axios.post(
                    '/logins/find/auth',
                    {
                        'email': email,
                        'inputAuthNum': inputAuthNum,
                    },)
                    .then((response) => {
                        location.href = "{% url 'logins:showId' %}";
                    })
                    .catch((response) => {
                        if(document.querySelector('#input_auth_num').value == ''){
                            alert('회원님의 이메일로 전송된 인증번호를 입력해주세요.');
                        }else{
                            alert('인증번호가 일치하지 않습니다.');
                        }
                    })
            })
        })
        .catch((response) => {
            if (name == '' || email == ''){
                alert('이름, 이메일을 모두 입력해주세요.');
            }else{
                alert('입력하신 정보가 일치하지 않거나 존재하지 않습니다.');
            }
            
        })
    });

</script>
</body>
</html>