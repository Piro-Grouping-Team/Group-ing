<!DOCTYPE html>
<html lang="en">
  {% load static %}
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'css/logins/findPW.css' %}" />
    <script
      src="https://kit.fontawesome.com/b453b8b1fc.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>FINDPW</title>
  </head>

  <body>
  <div class="container">
        <div class="title">
            <div class="btitle">패스워드 찾기</div>
            <div class="stitle">아이디/이름/이메일을 입력해주세요</div>
        </div>

        <div class="find_pw">
            {% csrf_token %}
            <div class="find_pw_detail">
                <label name="label_username" for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
                {{ form.username }}
            </div>
            <div class="find_pw_detail">
                <label name="label_name" for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                {{ form.name }}
            </div>
            <div class="find_pw_detail">
                <label name="label_email" for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                    {{ form.email }}
            </div>

            <div>등록하신 메일로 인증번호가 발송됩니다.</div>

            <div id="div_find_pw">
                <button id="find_pw" name="find_pw"class="find_pw_btn">비밀번호찾기</button>
            </div>
            <div id="loading"></div>
            <div id="result_pw"></div>
        </div>    
  </div>

<script>
    const button = document.querySelector('#find_pw');
    button.addEventListener('click', (event) => {
        var username = document.querySelector('#pw_form_id').value;
        var name = document.querySelector('#pw_form_name').value;
        var email = document.querySelector('#pw_form_email').value;
        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = 'X-CSRFToken';

        axios.post(
            '/logins/find/pw/find',
            {
            'username': username,
            'name': name,
            'email': email,
            },)
        .then((response) => {
            alert('회원님의 이메일로 인증코드를 발송하였습니다.');
            const element = document.querySelector('#result_pw');

            element.innerHTML = '<div class="row justify-content-md-center"><form class="form-inline"><div class="md-form md-outline"><label class="certificate_num" for="input_auth_num">인증번호 입력</label><input type="text" id="input_auth_num" class="form-control mx-sm-2" autofocus/></div></form>'+
            '<button type="submit" name="auth_confirm" id="id_auth_confirm" class="btn-certi"><i class="fas fa-check"></i>&nbsp;&nbsp;인증확인</button></div>'

            function countdown( elementName, minutes, seconds ) {
                      var elementName, endTime, hours, mins, msLeft, time;
                      function twoDigits( n ) {
                          return (n <= 9 ? "0" + n : n);
                      }
                      function updateTimer() {
                          msLeft = endTime - (+new Date);
                          if ( msLeft < 1000 ) {
                              alert("인증시간이 초과되었습니다.");
                              elementName.remove();
                              cert_ok = false;
                              certificationNum = false;
                              location.href = "{% url 'logins:findPw' %}"
                          } else {
                              time = new Date( msLeft );
                              hours = time.getUTCHours();
                              mins = time.getUTCMinutes();
                            //   $("" + elementName).html((hours ? hours + ':' + twoDigits( mins ) : twoDigits(mins))
                            //   + ':' + twoDigits( time.getUTCSeconds()));
                              setTimeout( updateTimer, time.getUTCMilliseconds() + 500 );
                          }
                      }
                      endTime = (+new Date) + 1000 * (60*minutes + seconds) + 500;
                      updateTimer();
                  }
            countdown("#timeset", 5, 0);
            console.log(response)
            var email = response.data.result
            const confirmButton = document.querySelector('#id_auth_confirm');
            confirmButton.addEventListener('click', (event) => {
                var inputAuthNum = document.querySelector('#input_auth_num').value;
                axios.post(
                    '/logins/find/auth',
                    {
                        'email': email,
                        'inputAuthNum': inputAuthNum,
                    },)
                    .then((response) => {
                        location.href = "{% url 'logins:findPwReset' %}";
                    })
                    .catch((response) => {
                        if(document.querySelector('#input_auth_num').value == ''){
                            alert('회원님의 이메일로 전송된 인증번호를 입력해주세요.');
                        }else{
                            alert('인증번호가 일치하지 않습니다.');
                        }
                    })
            })
        })
        .catch((response) => {
            if (username == '' || name == '' || email == ''){
                alert('아이디, 이름, 이메일을 모두 입력해주세요.');
            }else{
                alert('입력하신 정보가 일치하지 않거나 존재하지 않습니다.');
            }
            
        })
    });

</script>
</body>
</html>
